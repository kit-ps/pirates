version: "3.7"
services:
  caller:
    build:
      context: ./
      dockerfile: ./caller/Dockerfile
    volumes:
      - ./caller:/home/app/pirates:z
      - ./FastPIR:/home/app/pirates/FastPIR:z
      - ./audio:/audio:z
    cap_add:
      - NET_ADMIN
    networks:
      pirates-network:
        ipv4_address: ${IP_CALLER}
    command: >
      bash -c "cd /home/app/pirates
      && cmake . && make &&
      ./bin/caller -c ${IP_CALLER}
      -s ${MESSAGE_SIZE}
      -r ${NUM_ROUNDS}
      -e ${IP_RELAY}"
    init: true
  callee:
    build:
      context: ./
      dockerfile: ./callee/Dockerfile
    volumes:
      - ./callee:/home/app/pirates:z
      - ./FastPIR:/home/app/pirates/FastPIR:z
  #    - ./audio:/audio:z
    cap_add:
      - NET_ADMIN
    networks:
      pirates-network:
        ipv4_address: ${IP_CALLEE}
    command: >
      bash -c "cd /home/app/pirates
      && cmake . && make &&
      ./bin/callee -c ${IP_CALLEE}
      -s ${MESSAGE_SIZE}
      -r ${NUM_ROUNDS}
      -e ${IP_RELAY}
      -g ${GROUP_SIZE}"
    init: true
  worker:
    build:
      context: ./
      dockerfile: ./worker/Dockerfile
    volumes:
      - ./worker:/home/app/pirates:z
      - ./FastPIR:/home/app/pirates/FastPIR:z
    cap_add:
      - NET_ADMIN
    networks:
      pirates-network:
        ipv4_address: ${IP_WORKER}
    command: >
      bash -c "cd /home/app/pirates
      && cmake . && make &&
      ./bin/worker 
      -w ${IP_WORKER} 
      -c ${IP_CALLEE}
      -g ${GROUP_SIZE}
      -u ${NUM_USERS}
      -n ${NUM_MESSAGE}"
    init: true
  relay:
    build:
      context: ./
      dockerfile: ./relay/Dockerfile
    volumes:
      - ./relay:/home/app/pirates:z
      - ./FastPIR:/home/app/pirates/FastPIR:z
    cap_add:
      - NET_ADMIN
    networks:
      pirates-network:
        ipv4_address: ${IP_RELAY}
    command: >
      bash -c "cd /home/app/pirates
      && cmake . && make &&
      ./bin/relay -e ${IP_RELAY}
      -w ${IP_WORKER}
      -n ${NUM_MESSAGE}"
    init: true
networks:
  pirates-network:
    ipam:
      config:
        - subnet: ${SUBNET}
